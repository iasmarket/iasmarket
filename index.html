<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Top 10 Discounts by Category | IaSmarKet.us</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: #131421;
            box-sizing: border-box;
        }
        header {
            background: linear-gradient(120deg, #ff316a 0%, #27e3c2 100%);
            color: #fff;
            padding: 32px 0 26px 0;
            text-align: center;
            box-shadow: 0 2px 24px #0007;
            position: relative;
            background-size: 400% 400%;
            animation: gradientMove 8s ease infinite;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .logo {
            margin-left: 20px;
            width: 70px;
            height: auto;
            position: static;
        }
        .header-content {
            margin-left: 22px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .logo-title {
            font-size: 2.2em;
            font-weight: 900;
            letter-spacing: 2px;
            margin-bottom: 6px;
            text-shadow: 0 4px 18px #0007, 0 1px 0 #fff5;
            filter: drop-shadow(0 6px 16px #ff316a65);
            text-align: left;
        }
        .subtitle {
            font-size: 1.08em;
            font-weight: 500;
            margin-top: 8px;
            color: #fffde7;
            text-shadow: 0 2px 6px #0008;
            text-align: left;
        }
        h1 {
            text-align: center;
            color: #ff316a;
            font-size: 1.4em;
            margin-top: 30px;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px #0006;
        }
        main {
            min-height: 100vh;
            padding-bottom: 24px;
            background:
                linear-gradient(120deg, #181c22cc 40%, #1b2231dd 100%),
                url('bgrnd.png');
            background-repeat: repeat;
            background-size: auto, auto;
            display: flex;
        }
        /* Sidebar menu styles */
        .sidebar {
            width: 220px;
            min-width: 140px;
            background: linear-gradient(135deg, #181c22 75%, #1b2231 100%);
            border-top-right-radius: 23px;
            border-bottom-right-radius: 23px;
            box-shadow: 2px 0 18px #0007;
            padding: 22px 0 18px 0;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            position: sticky;
            top: 0;
            height: 90vh;
            margin: 18px 0 18px 0;
            z-index: 2;

            /* Ajouts pour activer le scroll et empÃªcher le 'scroll chaining' */
            overflow-y: auto;                     /* permet le dÃ©filement vertical */
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;    /* scrolling fluide sur iOS */
            overscroll-behavior: contain;         /* empÃªche le chainage du scroll vers le body */
        }
        .sidebar-title {
            font-size: 1.1em;
            color: #fff;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 0 16px 12px 20px;
            margin-bottom: 0;
            border-bottom: 1.5px solid #25273955;
            text-shadow: 0 2px 9px #27e3c288;
        }
        .group {
            padding: 5px 7px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .group-header {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: transparent;
            border: none;
            color: #eaeaea;
            padding: 9px 16px 9px 20px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            text-align: left;
            border-radius: 6px;
            transition: background 0.18s, color 0.18s;
        }
        .group-header:hover {
            background: linear-gradient(90deg,#27e3c220 0%,#ff316a11 100%);
            color: #ff316a;
        }
        .group-header .caret {
            margin-left: 8px;
            font-size: 0.98em;
            opacity: 0.9;
            transition: transform 0.25s;
        }
        .group.open .group-header .caret {
            transform: rotate(90deg);
        }
        .group-list {
            list-style: none;
            padding: 3px 8px 8px 8px;
            margin: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.28s ease;
        }
        .group-list.open {
            /* max-height set dynamically from JS */
        }
        .category-item {
            margin: 3px 0;
        }
        .category-link {
            display: block;
            padding: 7px 13px;
            color: #eaeaea;
            text-decoration: none;
            font-size: 1em;
            border-left: 4px solid transparent;
            transition:
                background 0.16s,
                color 0.16s,
                border-color 0.18s,
                box-shadow 0.18s;
            border-radius: 0 15px 15px 0;
            font-weight: 500;
            position: relative;
        }
        .category-link:hover,
        .category-link.active {
            background: linear-gradient(90deg,#27e3c220 0%,#ff316a11 100%);
            color: #ff316a;
            border-left: 4px solid #ff316a;
            box-shadow: 2px 0 16px #ff316a19;
            text-shadow: 0 2px 8px #ff316a44;
        }
        /* Main content wrapper */
        .main-content {
            flex: 1;
            padding-left: 0;
            width: 100%;
        }
        .main-content-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 14px;
        }
        /* --- CIEL BLEU pour chaque section catÃ©gorie --- */
        .repo-section {
            margin: 30px auto 0 auto;
            max-width: 1200px;
            padding: 0 8px 26px 8px;
            border-bottom: 2px solid #25273955;
            background: linear-gradient(120deg, #d7eaff 60%, #bee8fa 100%),
                        url('https://www.transparenttextures.com/patterns/clouds.png');
            background-repeat: repeat;
            border-radius: 16px;
            box-shadow: 0 8px 36px #a7d2ee66, 0 2px 12px #fff8;
            border: 1.5px solid #b7d2ee;
            margin-bottom: 24px;
        }
        .repo-title {
            font-size: 1.25em;
            font-weight: 700;
            color: #1d3b6d;
            text-align: center;
            display: block;
            margin: 18px 0 18px 0;
            text-decoration: none;
            transition: color 0.2s, text-shadow 0.2s;
            letter-spacing: 1px;
            text-shadow: 0 2px 12px #fff9, 0 1px 0 #d7eaff99;
        }
        .repo-title:hover {
            color: #ff316a;
            text-shadow: 0 1px 16px #ff316ad0;
        }
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            justify-content: center;
            align-items: stretch;
        }
        .product {
            background: linear-gradient(135deg, #232538ef 70%, #1a1c23f7 100%);
            border: 1.5px solid #252739;
            border-radius: 14px;
            width: 97%;
            max-width: 98vw;
            padding: 13px 8px 14px 8px;
            margin: 7px 0;
            text-align: center;
            box-shadow: 0 4px 32px #0007, 0 1.5px 8px #ff316a15;
            transition: transform 0.22s, box-shadow 0.22s;
            position: relative;
            overflow: hidden;
        }
        .product:hover {
            transform: scale(1.04);
            box-shadow: 0 10px 48px #ff316a3c, 0 8px 32px #000c;
            z-index: 2;
        }
        .product img {
            width: 100%;
            height: 170px;
            object-fit: cover;
            border-radius: 9px;
            box-shadow: 0 2px 12px #ff316a22;
            transition: filter 0.2s;
            background: #fff;
            display: block;
        }
        .discount {
            background: linear-gradient(90deg, #ff316a, #ffb156 85%);
            color: #fff;
            font-size: 1em;
            font-weight: bold;
            border-radius: 0 0 9px 9px;
            padding: 5px 0 5px 0;
            margin: 10px 0 4px 0;
            box-shadow: 0 2px 8px #ff316a24;
            letter-spacing: 2px;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            text-shadow: 0 1px 3px #0006;
        }
        .name {
            margin: 7px 0 6px 0;
            font-size: 1em;
            font-weight: 500;
            color: #f8f8f8;
            min-height: 38px;
            line-height: 1.2;
            text-shadow: 0 1px 3px #18181a60;
        }
        .description {
            color: #c8e6fa;
            font-size: 0.96em;
            margin: 4px 0 6px 0;
            padding: 0 2px;
            min-height: 25px;
            text-shadow: 0 1px 3px #0005;
        }
        .price {
            color: #ffb156;
            font-size: 1.03em;
            font-weight: 600;
            margin: 3px 0 6px 0;
            text-shadow: 0 1px 3px #0008;
        }
        .product a {
            color: #27e3c2;
            font-weight: bold;
            font-size: 1em;
            text-decoration: none;
            margin-top: 5px;
            display: inline-block;
            transition: color 0.2s;
        }
        .product a:hover {
            color: #ff316a;
            text-decoration: underline;
        }
        .loading {
            color: #aaa;
            text-align: center;
            margin: 40px 0 0 0;
            font-size: 1.15em;
        }
        #progress-container {
            width: 100%;
            max-width: 400px;
            margin: 24px auto 0 auto;
            display: none;
            background: #232538;
            border-radius: 8px;
            padding: 2px;
            box-shadow: 0 1px 8px #0004;
        }
        #progress-bar {
            height: 10px;
            background: linear-gradient(90deg,#ff316a,#27e3c2);
            width: 0%;
            border-radius: 8px;
            transition: width 0.3s;
        }
        .right-ribbon {
            position: fixed;
            top: 48px;
            right: -62px;
            z-index: 1000;
            background: linear-gradient(90deg, #ff316a, #27e3c2);
            color: #fff;
            font-weight: bold;
            font-size: 1em;
            padding: 10px 38px 10px 16px;
            border-radius: 14px 0 0 14px;
            box-shadow: 0 6px 22px #0006, 0 1.5px 8px #ff316a35;
            transform: rotate(28deg);
            letter-spacing: 1px;
            text-align: left;
            cursor: pointer;
            transition: right 0.2s, box-shadow 0.18s, background 0.22s;
        }
        .right-ribbon:hover {
            right: -10px;
            background: linear-gradient(90deg, #27e3c2, #ff316a);
            box-shadow: 0 10px 32px #ff316a6c, 0 8px 28px #000c;
        }
        /* Ribbon responsive */
        @media (max-width: 650px) {
            .right-ribbon {
                display: none;
            }
        }
        /* Responsive Sidebar & Main Content */
        @media (max-width: 1080px) {
            main { flex-direction: column; }
            .sidebar {
                position: static;
                height: auto;
                width: 100%;
                min-width: 0;
                border-radius: 0 0 26px 26px;
                margin: 0 0 16px 0;
                flex-direction: row;
                overflow-x: auto;   /* horizontal scroll en responsive */
                overflow-y: visible;
                box-shadow: 0 8px 18px #0007;
                padding: 8px 0 6px 0;
            }
            .sidebar-title {
                display: none;
            }
            .group {
                min-width: auto;
                padding: 3px 6px;
            }
            .group-header {
                padding: 8px 10px;
                border-radius: 8px;
            }
            .group-list {
                display: none !important;
                position: static;
            }
            .group.open .group-list {
                display: block !important;
                max-height: none !important;
                position: static;
            }
        }
        @media (max-width: 650px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                padding: 19px 0 14px 0;
            }
            .header-content { margin-left: 0; }
            .logo { margin-left: 10px; width: 55px;}
            .logo-title { font-size: 1.3em; }
            .subtitle { font-size: 0.96em; }
            .main-content-inner { padding: 0 2vw; }
            h1 { font-size: 1em; }
            .products { gap: 8px; grid-template-columns: 1fr; }
            .product { width: 99vw; max-width: 100vw;}
            .repo-section { padding: 0 2vw 16px 2vw; }
            #progress-container { max-width: 98vw; }
            .sidebar { padding: 2px 0 2px 0; }
            .repo-title { font-size: 1em; }
        }
        /* Ajout affichage (display label) style */
        .affichage-label {
            background: #27e3c2;
            color: #12121a;
            font-size: 1.03em;
            font-weight: 700;
            padding: 6px 16px;
            border-radius: 8px;
            margin: 8px auto 18px auto;
            display: inline-block;
            box-shadow: 0 1px 8px #27e3c245;
            letter-spacing: 1px;
            text-shadow: 0 1px 3px #fff7;
        }
    </style>
</head>
<body>
    <header>
        <img src="logo.png" alt="Logo" class="logo">
        <div class="header-content">
            <div class="logo-title">IaSmarKet.us</div>
            <div class="subtitle">
                IaSmarKet.us is an invitation to take advantage of great discounts and promotions!<br>
                Shop smart and seize the hottest deals now.
            </div>
        </div>
    </header>
    <main>
        <nav class="sidebar" id="sidebar-menu" aria-label="Categories">
            <div class="sidebar-title">Categories</div>
            <div id="category-list"></div>
        </nav>
        <div class="main-content">
            <div class="main-content-inner">
                <h1>Top 10 Products with the Highest Discounts by Category</h1>
                <div id="progress-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="results"></div>
                <div class="loading" id="loading">Loading data, please wait...</div>
            </div>
        </div>
    </main>
    <!-- Ruban Ã  droite -->
    <div class="right-ribbon" onclick="window.open('https://web.facebook.com/IASmarket', '_blank')">
        ðŸ’Ž FB Extra Deals!
    </div>
    <script>
    // Liste des "repositories" / catÃ©gories
    const repositories = [
      { name: " ðŸ  Maison, Jardin & Bricolage", url: " " },
      { name: " Appliances ", url: "https://iasmarket.github.io/Appliances/" },
      { name: " Home And Kitchen ", url: "https://iasmarket.github.io/HomeAndKitchen/" },
      { name: " Garden And Outdoor ", url: "https://iasmarket.github.io/GardenAndOutdoor/" },
      { name: " ðŸ’» Ã‰lectronique, Informatique & Logiciels", url: " " },
      { name: " Electronics ", url: "https://iasmarket.github.io/Electronics/" },
      { name: " Computers ", url: "https://iasmarket.github.io/Computers/" },
      { name: " Software ", url: "https://iasmarket.github.io/Software/" },
      { name: " ðŸ‘• Mode, Bijoux & Accessoires", url: " " },
      { name: " Fashion Men ", url: "https://iasmarket.github.io/FashionMen/" },
      { name: " FashionBoys ", url: "https://iasmarket.github.io/FashionBoys/" },
      { name: " FashionBaby ", url: "https://iasmarket.github.io/FashionBaby/" },
      { name: " Jewelry ", url: "https://iasmarket.github.io/Jewelry/" },
      { name: " Luggage ", url: "https://iasmarket.github.io/Luggage/" },
      { name: " ðŸ§´ BeautÃ©, SantÃ© & BÃ©bÃ©", url: " " },
      { name: " Beauty", url: "https://iasmarket.github.io/Beauty/" },
      { name: " Health Personal Care ", url: "https://iasmarket.github.io/HealthPersonalCare/" },
      { name: " Baby ", url: "https://iasmarket.github.io/Baby/" },
      { name: " ðŸ§¸ Jouets, Loisirs & CrÃ©ativitÃ©", url: " " },
      { name: " Arts And Crafts ", url: "https://iasmarket.github.io/ArtsAndCrafts/" },
      { name: " âš½ Sports, Plein Air & Loisirs", url: " " },
      { name: " Automotive ", url: "https://iasmarket.github.io/Automotive/" },
      { name: " Industrial ", url: "https://iasmarket.github.io/Industrial/" },
      { name: " ðŸ” Alimentation, Animaux & Cadeaux", url: " " },
      { name: " Grocery And Gourmet Food ", url: "https://iasmarket.github.io/GroceryAndGourmetFood/" },
      { name: " Pet Supplies & Gourmet Food", url: "https://iasmarket.github.io/PetSupplies/" },
      { name: " ðŸ§¾ Bureau & Divers", url: " " },
      { name: " Office Products ", url: "https://iasmarket.github.io/OfficeProducts/" },
    ];

    // Build groups (entries with empty or whitespace-only url are group titles)
    const groups = [];
    repositories.forEach((repo, idx) => {
        const isGroupTitle = !(repo.url && repo.url.toString().trim());
        if (isGroupTitle) {
            groups.push({ title: repo.name.trim(), children: [] });
        } else {
            if (groups.length === 0) groups.push({ title: 'Categories', children: [] });
            groups[groups.length - 1].children.push({ ...repo, idx });
        }
    });

    // Render sidebar accordion groups
    const categoryContainer = document.getElementById('category-list');
    function setActiveLink(link) {
        document.querySelectorAll('.category-link').forEach(a => a.classList.remove('active'));
        if (link) link.classList.add('active');
    }
    groups.forEach((group, gi) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        const header = document.createElement('button');
        header.className = 'group-header';
        header.type = 'button';
        header.setAttribute('aria-expanded', 'false');
        header.innerHTML = `<span>${group.title}</span><span class="caret">â€º</span>`;
        const list = document.createElement('ul');
        list.className = 'group-list';
        list.setAttribute('aria-hidden', 'true');

        group.children.forEach(child => {
            const li = document.createElement('li');
            li.className = 'category-item';
            const a = document.createElement('a');
            a.className = 'category-link';
            a.href = '#cat-' + child.idx;
            a.textContent = child.name.trim();
            a.dataset.catidx = child.idx;
            a.dataset.url = child.url;
            // click behavior: scroll to section if present, otherwise open external URL
            a.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = a.getAttribute('href');
                const section = document.querySelector(targetId);
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setActiveLink(a);
                } else if (a.dataset.url && a.dataset.url.trim()) {
                    window.open(a.dataset.url, '_blank', 'noopener');
                }
            });
            li.appendChild(a);
            list.appendChild(li);
        });

        // Toggle on header click
        header.addEventListener('click', () => {
            const isOpen = header.getAttribute('aria-expanded') === 'true';
            header.setAttribute('aria-expanded', String(!isOpen));
            if (!isOpen) {
                list.style.maxHeight = list.scrollHeight + 'px';
                list.classList.add('open');
                list.setAttribute('aria-hidden', 'false');
                groupDiv.classList.add('open');
            } else {
                list.style.maxHeight = null;
                list.classList.remove('open');
                list.setAttribute('aria-hidden', 'true');
                groupDiv.classList.remove('open');
            }
        });

        groupDiv.appendChild(header);
        groupDiv.appendChild(list);
        categoryContainer.appendChild(groupDiv);
    });

    // Expand first group by default (if any)
    (function expandFirstGroup() {
        const firstHeader = document.querySelector('.group .group-header');
        if (firstHeader) firstHeader.click();
    })();

    // Deduplication
    const seenProducts = new Set();

    // Helper to extract name/description from element
    function extractNameAndDescription(el) {
        const ps = el.querySelectorAll('p');
        let name = "";
        let description = "";
        if (ps.length === 1) {
            name = ps[0].textContent.trim();
        } else if (ps.length >= 2) {
            name = ps[0].textContent.trim();
            // find a <p> that is not discount or price
            for (let i = 1; i < ps.length; i++) {
                const txt = ps[i].textContent.trim();
                if (!/(\d+)\s*%/i.test(txt) && !/^[â‚¬$Â£]\s*\d/.test(txt)) {
                    description = txt;
                    break;
                }
            }
        }
        return { name, description };
    }

    // Escape HTML to prevent injection when building innerHTML
    function escapeHTML(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    async function fetchAndParseProducts(repo) {
        // Skip group headers or empty URLs
        if (!repo.url || !repo.url.toString().trim()) return [];
        try {
            const res = await fetch(repo.url);
            if (!res.ok) return [];
            const html = await res.text();
            const div = document.createElement('div');
            div.innerHTML = html;
            const products = [...div.querySelectorAll('.product')];

            const productObjs = products.map(el => {
                const imgEl = el.querySelector('img');
                const aEl = el.querySelector('a');

                // Resolve relative URLs against repo.url
                let image = '';
                try {
                    const src = imgEl ? (imgEl.getAttribute('src') || '') : '';
                    image = src ? new URL(src, repo.url).href : '';
                } catch (e) {
                    image = imgEl?.src || '';
                }

                let link = '';
                try {
                    const href = aEl ? (aEl.getAttribute('href') || '') : '';
                    link = href ? new URL(href, repo.url).href : '';
                } catch (e) {
                    link = aEl?.href || '';
                }

                // Name/description
                let { name, description } = extractNameAndDescription(el);
                if (!name) name = imgEl?.alt?.trim() || "Product";

                // Find any text nodes that could contain discount or price
                const texts = Array.from(el.querySelectorAll('p,span,div')).map(n => n.textContent || '').map(t => t.trim()).filter(Boolean);

                // Discount detection: find number followed by %
                const discountText = texts.find(t => /-?\d+\s*%/i.test(t));
                const discountMatch = discountText ? discountText.match(/-?(\d+)\s*%/i) : null;
                const discount = discountMatch ? parseInt(discountMatch[1], 10) : 0;

                // Price detection: look for currency symbol then number
                const priceText = texts.find(t => /[â‚¬$Â£]\s*\d+([.,]\d+)?/.test(t));
                const price = priceText ? priceText : '';

                return { name: name.trim(), description: description.trim(), link, image, discount, price };
            })
            .filter(p => p.discount > 0 && (p.link || p.image));
            productObjs.sort((a, b) => b.discount - a.discount);

            // Take the first 10 unique products (no duplicate image or link)
            const unique = [];
            for (let prod of productObjs) {
                const key = (prod.link || '') + '|' + (prod.image || '');
                if (!seenProducts.has(key)) {
                    seenProducts.add(key);
                    unique.push(prod);
                }
                if (unique.length >= 10) break;
            }
            return unique;
        } catch (e) {
            console.error('fetchAndParseProducts error for', repo.url, e);
            return [];
        }
    }

    async function main() {
        const resultsDiv = document.getElementById('results');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        progressContainer.style.display = 'block';
        let html = '';

        // Process each repository (category)
        for (let i = 0; i < repositories.length; i++) {
            const repo = repositories[i];
            const products = await fetchAndParseProducts(repo);
            if (!products.length) {
                // update progress anyway
                progressBar.style.width = Math.round((i + 1) / repositories.length * 100) + '%';
                continue;
            }

            // Build section safely using escaped values
            html += `<div class="repo-section" id="cat-${i}" data-catidx="${i}">
                <a class="repo-title" href="${escapeHTML(repo.url)}" target="_blank" rel="noopener noreferrer">${escapeHTML(repo.name)}</a>
                <div class="products">`;
            products.forEach(product => {
                html += `<div class="product">
                    <a href="${escapeHTML(product.link)}" target="_blank" rel="noopener noreferrer"><img src="${escapeHTML(product.image)}" alt="${escapeHTML(product.name)}"></a>
                    <div class="discount">-${escapeHTML(String(product.discount))}% OFF</div>
                    <div class="name">${escapeHTML(product.name)}</div>
                    <div class="description">${escapeHTML(product.description || '')}</div>
                    <div class="price">${escapeHTML(product.price || '')}</div>
                    <a href="${escapeHTML(product.link)}" target="_blank" rel="noopener noreferrer">View product</a>
                </div>`;
            });
            html += `</div>
                <a class="repo-title" href="${escapeHTML(repo.url)}" target="_blank" rel="noopener noreferrer">Click for more ${escapeHTML(repo.name)} products! </a>
            </div>`;
            // Update progress
            progressBar.style.width = Math.round((i + 1) / repositories.length * 100) + '%';
        }

        progressContainer.style.display = 'none';
        resultsDiv.innerHTML = html || '<div style="color:red;text-align:center;">No products found.</div>';
        document.getElementById('loading').style.display = 'none';
    }

    // Highlight sidebar category when scrolling to its section
    function setupSidebarScrollHighlight() {
        const sectionEls = Array.from(document.querySelectorAll('.repo-section'));
        const linkEls = Array.from(document.querySelectorAll('.category-link'));

        function findLinkForIndex(idx) {
            return document.querySelector(`.category-link[data-catidx="${idx}"]`);
        }

        function onScroll() {
            let idxToActivate = null;
            for (let i = 0; i < sectionEls.length; i++) {
                const rect = sectionEls[i].getBoundingClientRect();
                if (rect.top < 140) {
                    const dataIdx = sectionEls[i].dataset.catidx;
                    idxToActivate = dataIdx;
                }
            }
            if (idxToActivate === null && sectionEls.length > 0) {
                idxToActivate = sectionEls[0].dataset.catidx;
            }
            linkEls.forEach(a => a.classList.remove('active'));
            if (idxToActivate !== null) {
                const link = findLinkForIndex(idxToActivate);
                if (link) {
                    link.classList.add('active');
                    // Ensure its group is open so the active link is visible
                    const groupList = link.closest('.group-list');
                    if (groupList && !groupList.classList.contains('open')) {
                        const header = groupList.previousElementSibling;
                        if (header && header.classList.contains('group-header')) header.click();
                    }
                }
            }
        }
        window.addEventListener('scroll', onScroll, { passive: true });

        // When clicking any link, mark active
        linkEls.forEach(a => {
            a.addEventListener('click', () => {
                setActiveLink(a);
            });
        });
    }

    // Convert vertical wheel to horizontal scroll when sidebar is horizontal (responsive)
    (function enableHorizontalWheelOnSmall() {
      const sidebar = document.querySelector('.sidebar');
      if (!sidebar) return;

      function onWheel(e) {
        // apply only on small screens where sidebar is in row mode
        if (window.matchMedia('(max-width:1080px)').matches) {
          // if vertical scroll is dominant, translate to horizontal
          if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
            sidebar.scrollLeft += e.deltaY;
            e.preventDefault(); // prevent page scroll
          }
        }
      }
      // passive: false to allow preventDefault()
      sidebar.addEventListener('wheel', onWheel, { passive: false });
    })();

    // Start
    main().then(() => {
        setupSidebarScrollHighlight();
    });
    </script>
</body>
</html>
